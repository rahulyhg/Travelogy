@model WebApplication1.Models.EditTripViewModel

@Html.Partial("_HomepageCarousel")

@*if there is an active trip for rditing ---*@
@if (Model.ActiveTrip != null)
{
    <div class="headline">
        <h2>Your trip to: @Model.ActiveTrip.DlTripView.Name</h2>        
    </div>

    <div class="row">
        <div class="col-sm-4 info-blocks">
            <i class="icon-calendar icon-info-blocks"></i>
            <div class="info-blocks-in">
                <h3>
                    Planned date:
                    @if (Model.ActiveTrip.DlTripView.StartDate.HasValue)
                    {
                        @Model.ActiveTrip.DlTripView.StartDate.Value.ToLongDateString()
                    }
                    else
                    {
                        @Html.Raw("Not planned")
                    }
                </h3>
            </div>
        </div>
        <div class="col-sm-4 info-blocks">
            <i class="icon-ok-sign icon-info-blocks"></i>
            <div class="info-blocks-in">
                <h3>Status: @Model.ActiveTrip.DlTripView.Status</h3>
            </div>
        </div>
        <div class="col-sm-4 info-blocks">
            <i class="icon-map-marker icon-info-blocks"></i>
            <div class="info-blocks-in">
                <h3>Starts at: @Model.ActiveTrip.DlTripView.StartLocation</h3>
            </div>
        </div>
    </div>

    <hr class="margin-bottom-40">             

        <div class="tab-v1">
            <ul class="nav nav-tabs">
                <li class="active"><a href="#details" data-toggle="tab">Trip Summary</a></li>
                <li><a href="#booking" data-toggle="tab">Booking details</a></li>     
                <li><a href="#messages" data-toggle="tab">Messages</a></li>                       
            </ul>
            <div class="tab-content">
                <div class="tab-pane active" id="details">
                @using (Html.BeginForm("SaveTrip", "Service", new { ReturnUrl = ViewBag.ReturnUrl }, FormMethod.Post, new { role = "form" }))
                {
                    @Html.AntiForgeryToken();
                    @Html.HiddenFor(p => p.ActiveTrip.DlTripView.Id);

                    <div class="row">
                        <div class="col-md-12">
                            <div class="margin-bottom-10"></div>
                            @if (Model.ActiveTrip.DlTransportsBookingsView != null)
                            {
                                if (Model.ActiveTrip.DlTransportsBookingsView.Count > 0)
                                {
                                    var _bookings = Model.ActiveTrip.DlTransportsBookingsView.Where(p => p.TripStepId == 0).ToList();
                                    foreach (var _booking in _bookings)
                                    {
                                        <h4 class="orange">Flight booking# @_booking.Id</h4>
                                        <p>@_booking.TransportFrom to @_booking.TransportTo on @_booking.BookingDate.Value.ToShortDateString()</p>
                                    }
                                }
                            }
                            <a class="btn btn-default" href="/Service/AddFlightBooking?TripId=@Model.ActiveTrip.DlTripView.Id"><i class="icon-plane"></i>&nbsp; Add Flight Booking</a>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-3 col-sm-12">                            
                            <h5 class="orange">Trip Ref # @Model.ActiveTrip.DlTripView.Id</h5>
                            <h5>Planned start date: @if (Model.ActiveTrip.DlTripView.StartDate.HasValue) { @Model.ActiveTrip.DlTripView.StartDate.Value.ToShortDateString()}</h5>
                            <p>Change date to: @Html.TextBoxFor(model => model.ActiveTrip.DlTripView.StartDate, new { @class = "form-control", type = "date" })</p>
                            <p>Start Location: @Html.TextBoxFor(model => model.ActiveTrip.DlTripView.StartLocation, new { @class = "form-control" }) </p>
                            <h5>Current status: @Model.ActiveTrip.DlTripView.Status</h5>                            
                            <p><button class="btn btn-orange" type="submit"><i class="icon-save"></i>&nbsp; Save trip</button></p>
                        </div>
                        <div class="col-md-6">                            
                        </div>
                    </div>
                    <div class="margin-bottom-20">                        
                    </div>
                    
                    <div class="row">
                        <div class="col-lg-12 col-sm-12">

                            @for (int x = 0; x < Model.ActiveTrip.DlTripStepsView.Count; x++)
                            {
                                var tripStep = Model.ActiveTrip.DlTripStepsView[x];
                                @Html.HiddenFor(p => p.ActiveTrip.DlTripStepsView[x].Id)

                                <div class="row">
                                    <div class="col-md-12">
                                        <h4 class="orange">@tripStep.ShortDescription</h4>
                                        <p>@tripStep.LongDescription</p>
                                    </div>

                                    <div class="col-md-3 col-sm-12">
                                        <h4>Start date: 
                                        @if (tripStep.StartDate.HasValue)
                                        { 
                                            @tripStep.StartDate.Value.ToShortDateString()
                                        }
                                        </h4>
                                        <p>Change to: @Html.TextBoxFor(p => p.ActiveTrip.DlTripStepsView[x].StartDate, new { @class = "form-control", type = "date" })</p>
                                    </div>

                                    <div class="col-md-3 col-sm-12">
                                        <h4>
                                            End date:
                                            @if (tripStep.EndDate.HasValue)
                                            {
                                                @tripStep.EndDate.Value.ToShortDateString()
                                            }
                                        </h4>
                                        <p>Change to: @Html.TextBoxFor(p => p.ActiveTrip.DlTripStepsView[x].EndDate, new { @class = "form-control", type = "date" })</p>
                                    </div>

                                    @if (!string.IsNullOrEmpty(Model.ActiveTrip.DlTripStepsView[x].TravelogerNote))
                                    {
                                        <div class="col-md-9">
                                            <h5 class="orange">Traveloger's Notes:</h5>
                                            <p class="orange">@Model.ActiveTrip.DlTripStepsView[x].TravelogerNote</p>
                                        </div>
                                    }

                                    <div class="col-md-9">
                                        <h5>Add notes:</h5>
                                        <p>@Html.TextAreaFor(p => p.ActiveTrip.DlTripStepsView[x].TravellerNote, new { @class = "form-control" })</p>
                                        <div class="margin-bottom-20"></div>
                                        <button class="btn btn-default" type="submit">Save Notes</button>
                                        <a class="btn btn-default" href="/Service/AddFlightBooking?TripId=@tripStep.TripId&tripStepId=@tripStep.Id"><i class="icon-plane"></i>&nbsp; Add Local Flight</a>
                                        @*<a class="btn btn-default" href="/Service/AddLocalTransfer?TripId=@tripStep.TripId&tripStepId=@tripStep.Id"><i class="icon-cog"></i>&nbsp; Add Local Transfer</a>*@
                                        <a class="btn btn-default" href="/Service/AddTripBookingAccommodation?tripStepId=@tripStep.Id&tripId=@tripStep.TripId"><i class="icon-building"></i>&nbsp;Add Accommodation</a>
                                        <div class="margin-bottom-20"></div>
                                        <button class="btn btn-orange" type="submit">Save Trip</button>
                                    </div>
                                </div>
                                <hr />
                            }

                        </div>
                    </div>
                } 
                </div>
                <div class="tab-pane" id="booking">
                    @Html.Partial("_TripBookings", Model.ActiveTrip)
                </div>     
                
                <div class="tab-pane" id="messages">
                    <h4>Messages for your trip [@Model.ActiveTrip.DlTripView.Id]</h4>
                    @{
                        // if there are no messages sent for this trip - start a descussion
                        if (Model.ActiveTrip.DlTripView.ThreadId == null || Model.ActiveTrip.DlTripView.ThreadId == 0)
                        {
                            var _model = new WebApplication1.Models.MessageViewModel() { TripId = Model.ActiveTrip.DlTripView.Id };
                            Html.RenderPartial("_MessageThreadStart", _model);
                        }

                        if (Model.ActiveTrip.DlTripView.ThreadId > 0)
                        {
                            DomingoBL.MessageCollection _thread = null;
                            DomingoBL.ThreadManager.GetMessageThreadById(Model.ActiveTrip.DlTripView.ThreadId.Value, out _thread);
                            if (_thread != null)
                            {
                                var _model = new WebApplication1.Models.MessageListItemViewModel()
                                { MessageThread = _thread, TripId = Model.ActiveTrip.DlTripView.Id, ShowTripViewLink = false };
                                Html.RenderPartial("_MessageThread", _model);
                            }
                        }
                    }
                </div>              
            </div>
        </div>        

        <h1>@Html.ValidationSummary()</h1>
    
}
@*end of edit trip section*@


@if (Model.RelatedTemplates != null && Model.RelatedTemplates.Count > 0)
{

    <div class="headline">
        <h2>Related trips</h2>
    </div>
        <div class="margin-bottom-20">
            <p class="orange">Following Trip(s) are suggested for you to add to the current trip. You can combine multiple circuits to plan a longer trip.</p>
        </div>

    foreach (var template in Model.RelatedTemplates)
    {
        @Html.Partial("_TripTemplateWidget", new WebApplication1.Models.TripTemplateWidgetViewModel { TripId = Model.ActiveTrip.DlTripView.Id, TripTemplate = template })
    }
}