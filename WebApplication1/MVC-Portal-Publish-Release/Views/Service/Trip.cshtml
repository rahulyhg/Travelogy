@model WebApplication1.Models.TripViewModel

@Html.Partial("_HomepageCarousel")


@*if the user is looking at templates, list them*@ 

@if (@Model.AllTemplates != null)
{
    Html.RenderPartial("_Trip_ShowTemplates", Model);
}        

@*if the user is creating a new trip - show the form*@
@if (Model.CreateTripTemplate != null)
{
    Html.RenderPartial("_Trip_CreateNewTrip", Model);    
}


@*if there is an active trip ---*@ 
@if (Model.ActiveTrip != null)
{
    <div class="headline">
        <h2>@Model.ActiveTrip.DlTripView.NickName <small class="orange">your trip to @Model.ActiveTrip.DlTripView.Name</small> </h2>                 
    </div>    
    <div class="row">
        <div class="col-sm-4 info-blocks">
            <i class="icon-calendar icon-info-blocks"></i>
            <div class="info-blocks-in">
                <h3>Planned date:
                    @if (Model.ActiveTrip.DlTripView.StartDate.HasValue)
                    {
                        @Model.ActiveTrip.DlTripView.StartDate.Value.ToLongDateString()
                    }
                    else
                    {
                        @Html.Raw("Not planned")
                    }
                </h3>                
            </div>
        </div>
        <div class="col-sm-4 info-blocks">
            <i class="icon-ok-sign icon-info-blocks"></i>
            <div class="info-blocks-in">
                <h3>Status: @Model.ActiveTrip.DlTripView.Status</h3>                
            </div>
        </div>
        <div class="col-sm-4 info-blocks">
            <i class="icon-map-marker icon-info-blocks"></i>
            <div class="info-blocks-in">
                <h3>Starts at: @Model.ActiveTrip.DlTripView.StartLocation</h3>                
            </div>
        </div>
    </div>

    <hr class="margin-bottom-40">
    <div class="pull-left">
        <a href="/Service/EditTrip?tripId=@Model.ActiveTrip.DlTripView.Id" class="btn btn-orange"> Edit trip &nbsp; <i class="icon-edit"></i></a>
    </div>
    <div class="margin-bottom-10"></div>

    <div class="tab-v1">
        <ul class="nav nav-tabs">
            <li class="active"><a href="#details" data-toggle="tab">Trip Details</a></li>
            <li><a href="#booking" data-toggle="tab">Booking details</a></li>
            <li><a href="#messages" data-toggle="tab">Messages</a></li>            
        </ul>
        <div class="tab-content">
            <div class="tab-pane active" id="details">                
                    @foreach (var tripStep in Model.ActiveTrip.DlTripStepsView)
                    {
                        <div class="row portfolio-item margin-bottom-40">
                            <div class="col-md-12 md-margin-bottom-40">
                                <h3>@tripStep.ShortDescription</h3>
                                <h5 class="orange">
                                    Planned Dates: 
                                    @if(tripStep.StartDate.HasValue)
                                    {
                                        @Html.Raw(tripStep.StartDate.Value.ToShortDateString());
                                    }
                                    else
                                    {
                                        @Html.Raw("Not Planned");
                                    }

                                    &nbsp; -- &nbsp;
                                    @if (tripStep.EndDate.HasValue)
                                    {
                                        @Html.Raw(tripStep.EndDate.Value.ToShortDateString());
                                    }
                                    else
                                    {
                                        @Html.Raw("Not Planned");
                                    }
                                </h5>

                                <p>@tripStep.LongDescription</p>

                                @if (!string.IsNullOrEmpty(tripStep.TravellerNote))
                                {
                                    <h5 class="orange">Your Notes:</h5>
                                    <p>@tripStep.TravellerNote</p>
                                }


                                @if (!string.IsNullOrEmpty(tripStep.TravelogerNote))
                                {
                                    <h5 class="orange">Traveloger's Notes:</h5>
                                    <p class="orange">@tripStep.TravelogerNote</p>
                                }
                            </div>
                        </div>                        
                    }
                    
            </div>
            <div class="tab-pane" id="booking">
                @Html.Partial("_TripBookings", Model.ActiveTrip)
            </div>
            <div class="tab-pane" id="messages">
                <h4>Messages for your trip [@Model.ActiveTrip.DlTripView.Id]</h4>
                @{ 
                    // if there are no messages sent for this trip - start a descussion
                    if (Model.ActiveTrip.DlTripView.ThreadId == null || Model.ActiveTrip.DlTripView.ThreadId == 0)
                    {
                        var _model = new WebApplication1.Models.MessageViewModel() { TripId = Model.ActiveTrip.DlTripView.Id };
                        Html.RenderPartial("_MessageThreadStart", _model);
                    }

                    if (Model.ActiveTrip.DlTripView.ThreadId > 0)
                    {
                        DomingoBL.MessageCollection _thread = null;
                        DomingoBL.ThreadManager.GetMessageThreadById(Model.ActiveTrip.DlTripView.ThreadId.Value, out _thread);
                        if (_thread != null)
                        {
                            var _model = new WebApplication1.Models.MessageListItemViewModel()
                                            { MessageThread = _thread, TripId = Model.ActiveTrip.DlTripView.Id , ShowTripViewLink = false };
                            Html.RenderPartial("_MessageThread", _model);
                        }
                    }
                }                
            </div>            
        </div>
    </div>

    <div class="pull-left">
        <a href="/Service/EditTrip?tripId=@Model.ActiveTrip.DlTripView.Id" class="btn btn-orange"> Edit trip &nbsp; <i class="icon-edit"></i></a>
    </div>  

    <div class="margin-bottom-20"></div>

    if (Model.RelatedTemplates != null && Model.RelatedTemplates.Count > 0)
    {

        <div class="headline">
            <h2>Related trips</h2>             
        </div> 
        <div class="margin-bottom-20">
            <p class="orange">Following Trip(s) are suggested for you to add to the current trip. You can combine multiple circuits to plan a longer trip.</p>            
        </div>
        
        foreach (var template in Model.RelatedTemplates)
        {
            @Html.Partial("_TripTemplateWidget", new WebApplication1.Models.TripTemplateWidgetViewModel { TripId = Model.ActiveTrip.DlTripView.Id, TripTemplate = template })
        }
    }

 } @*end of active trip section*@
